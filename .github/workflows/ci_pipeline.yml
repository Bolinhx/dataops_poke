
name: CI - Pipeline de Dados Pokémon

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_test_pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar dependências
        run: pip install -r requirements.txt
        
      - name: Verificar segredos
        run: |
          if [ -z "${{ secrets.DB_HOST }}" ]; then echo "DB_HOST secret is not set!"; exit 1; fi
          if [ -z "${{ secrets.DB_USER }}" ]; then echo "DB_USER secret is not set!"; exit 1; fi
          if [ -z "${{ secrets.DB_PASSWORD }}" ]; then echo "DB_PASSWORD secret is not set!"; exit 1; fi
          if [ -z "${{ secrets.DB_NAME }}" ]; then echo "DB_NAME secret is not set!"; exit 1; fi
          if [ -z "${{ secrets.DB_PORT }}" ]; then echo "DB_PORT secret is not set!"; exit 1; fi
          
      - name: Criar arquivo .env
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST }}" > pokedb.env
          # ... (adicione as outras 4 variáveis de ambiente como antes)

      - name: Configurar perfil do dbt
        run: |
          mkdir -p ~/.dbt
          # ... (adicione a configuração do profiles.yml como antes)

      - name: Limpar modelos dbt antigos (Staging e Marts)
        run: dbt clean --project-dir ./poke_dbt && dbt run --models staging marts --full-refresh --project-dir ./poke_dbt
        continue-on-error: true 

      - name: Rodar script de ingestão (Prefect)
        run: python3 ingestions.py

      - name: Rodar dbt build
        run: dbt build --project-dir ./poke_dbt
